<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Studio Elle - Ricerca Immagini</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='logo.ico') }}">
</head>
<body class="homepage">

    <!-- Cabeçalho com menu -->
    <header>
        <div class="container">
            <a href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="ByteAI Logo" class="logo">
                <span class="brand-name">Studio Elle Ricerca Immagini</span>
            </a>

            <nav>
                <ul>
                    {% if session.logged_in %}
                        <li><a href="{{ url_for('index') }}">Home</a></li>
                        <li><a href="{{ url_for('configurazioni') }}">Impostazioni</a></li>
                        <li><a href="{{ url_for('geracao') }}">IA GENERATIVA</a></li>
                        <li><a href="{{ url_for('utilidades') }}">Utilità</a></li>
                        <li><a href="{{ url_for('about') }}">About</a></li>
                        <li><a href="{{ url_for('logout') }}" style="color:red;">Logout</a></li>
                    {% else %}
                        <li><a href="#">Home</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </header>

    <!-- Mensagens de feedback -->
    <div class="messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="message {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Se logado, mostra o formulário de busca -->
    {% if session.logged_in %}
    <div class="search-container">
        <div class="search-box">
            <form action="{{ url_for('ricerca') }}" method="post" id="search-form" enctype="multipart/form-data" onsubmit="return validateAndShowSpinner()">
                <h1>Cerca Immagini</h1>

                <!-- Campo de pesquisa de texto -->
                <input type="text" name="input_testo" placeholder="Inserisci una descrizione...">

                <!-- Seleção de categoria (opcional) -->
                <select name="categoria" id="categoria-select" onchange="caricaTags()">
                    <option value="">-- Seleziona una categoria (opzionale) --</option>
                    {% for nome_categoria in categorie %}
                        <option value="{{ nome_categoria }}">{{ nome_categoria }}</option>
                    {% endfor %}
                </select>

                <!-- Input p/ imagem (oculto) -->
                <input
                  type="file"
                  name="image_file"
                  id="image-input"
                  accept="image/*"
                  capture="camera"
                  style="display: none;"
                  onchange="exibirNomeImagem()"
                >

                <!-- Botão p/ abrir camera ou arquivo -->
                <button
                  type="button"
                  class="search-button"
                  style="margin: 15px 0; padding: 10px 15px; font-size: 14px;"
                  onclick="document.getElementById('image-input').click();"
                >
                  Seleziona Immagine
                </button>

                <!-- Texto para exibir nome do arquivo escolhido -->
                <p id="image-selected-message"
                   style="display: none; margin: 5px 0; color: #555; font-style: italic; font-size: 0.9rem;"
                >
                  Immagine selezionata: <span id="image-name"></span>
                </p>

                <!-- Seleção de diretórios (checkbox) -->
                <label class="directory-label">Seleziona le directory per la ricerca:</label>
                <div class="directories-selection">
                    {% for d in directories_indicizzate %}
                        {% set path = d.path %}
                        {% set nome = d.nome %}
                        {% if nome %}
                            {% set display_label = nome %}
                        {% else %}
                            {# Fallback: mostrar somente a última parte do path #}
                            {% set short_dir = path.split('/')[-1] if '/' in path else path %}
                            {% set display_label = short_dir %}
                        {% endif %}
                        <div>
                            <input type="checkbox" name="directories_selezionate" value="{{ path }}" id="dir{{ loop.index }}">
                            <label for="dir{{ loop.index }}" title="{{ path }}"> {{ display_label }} </label>
                        </div>
                    {% endfor %}
                </div>

                <!-- Campo hidden p/ tags selecionadas via JS -->
                <input type="hidden" name="tags_selezionate" id="tags-selezionate-input">

                <!-- Botão de pesquisa -->
                <button type="submit" class="search-button" style="margin-top: 15px;">
                  Cerca Immagini
                </button>
            </form>
        </div>

        <!-- Div p/ exibir as tags -->
        <div class="tags-container" id="tags-container">
            <h3>Tag della Categoria</h3>
            <button id="select-all-tags">Seleziona Tutto</button>
            <div id="tags-list">
                <!-- As tags serão inseridas aqui dinamicamente -->
            </div>
        </div>
    </div>
    {% else %}
    <!-- Overlay de login se não logado -->
    <div class="login-overlay">
        <div class="login-box-floating">
            <h2 style="text-align:center;">Effettua l'accesso</h2>
            <form action="{{ url_for('fazer_login') }}" method="post">
                <label for="username">Nome Utente:</label>
                <input type="text" name="username" id="username" required>

                <label for="password">Password:</label>
                <input type="password" name="password" id="password" required>

                <button type="submit" class="search-button" style="width:100%; margin-top:10px;">Accedi</button>
            </form>
        </div>
    </div>
    {% endif %}

    <footer class="footer">
        <p>&copy; 2025 Powered by FuturaForma. Tutti i diritti riservati.</p>
    </footer>

    <!-- Overlay de carregamento (spinner) -->
    <div id="loading-overlay">
      <div class="spinner"></div>
    </div>

    <script>
      const categorie = {{ categorie|tojson }};

      // Exibir nome do arquivo selecionado
      function exibirNomeImagem() {
          const fileInput = document.getElementById('image-input');
          const msgElem = document.getElementById('image-selected-message');
          const nameElem = document.getElementById('image-name');
          if (fileInput.files.length > 0) {
              nameElem.textContent = fileInput.files[0].name;
              msgElem.style.display = 'block';
          } else {
              msgElem.style.display = 'none';
          }
      }

      // Carregar as tags ao selecionar a categoria
      function caricaTags() {
          const categoriaSelect = document.getElementById('categoria-select');
          const selectedCategoria = categoriaSelect.value;
          const tagsList = document.getElementById('tags-list');
          const tagsContainer = document.querySelector('.tags-container');
          tagsList.innerHTML = '';

          if (selectedCategoria && categorie[selectedCategoria]) {
              const tags = categorie[selectedCategoria]['tags'] || [];
              tags.forEach(tag => {
                  const tagElement = document.createElement('div');
                  tagElement.classList.add('tag');
                  tagElement.textContent = tag;
                  tagElement.onclick = () => {
                      tagElement.classList.toggle('selected');
                  };
                  tagsList.appendChild(tagElement);
              });
              tagsContainer.classList.add('active');
          } else {
              tagsContainer.classList.remove('active');
          }
      }

      // Botão "Seleziona Tutto"
      const selAllBtn = document.getElementById('select-all-tags');
      if(selAllBtn){
        selAllBtn.addEventListener('click', function() {
            const allTags = document.querySelectorAll('#tags-list .tag');
            const allSelected = Array.from(allTags).every(tag => tag.classList.contains('selected'));
            allTags.forEach(tag => {
                if (allSelected) {
                    tag.classList.remove('selected');
                } else {
                    tag.classList.add('selected');
                }
            });
        });
      }

      // Valida se pelo menos 1 diretório foi selecionado e exibe spinner
      function validateAndShowSpinner() {
          const directories = document.querySelectorAll('input[name="directories_selezionate"]:checked');
          if (directories.length === 0) {
              alert('Per favore, seleziona almeno una directory per la ricerca.');
              return false;
          }
          // Inclui as tags selecionadas no input hidden
          const selectedTags = Array.from(document.querySelectorAll('#tags-list .tag.selected'))
              .map(tag => tag.textContent);
          document.getElementById('tags-selezionate-input').value = selectedTags.join(',');

          // Exibe o overlay de carregamento
          document.getElementById('loading-overlay').style.display = 'flex';
          return true;
      }
    </script>
</body>
</html>
